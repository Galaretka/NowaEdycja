--[[
#---------------------------------------------------------------#
----* DayZ MTA Script weather_client.lua                    *----
----* Script created by: Unknown                            *----
----* New additions and functions by: Unknown               *----
#---------------------------------------------------------------#
]]

cyclones = {{0,0,0},{0,0,0},{0,0,0}}

function weatherCyclones (x1,y1,r1,x2,y2,r2,x3,y3,r3)
	cyclones[1][1] = x1
	cyclones[1][2] = y1
	cyclones[1][3] = r1
	cyclones[2][1] = x2
	cyclones[2][2] = y2
	cyclones[2][3] = r2
	cyclones[3][1] = x3
	cyclones[3][2] = y3
	cyclones[3][3] = r3
end
addEvent("weatherCyclones",true)
addEventHandler("weatherCyclones",getRootElement(),weatherCyclones)


weat_city = {12,12,15,15,66,66,12,12,61,58,63,28,28,28,6,11,11,11,11,11,11,11,2,2,14,14,14,14,34,34,34,34,1,1,1,1,17,17,18,3,3,3,3,3,1,0,3,3}
weat_green = {1,1,54,1,1,1,9,1,61,58,63,28,28,28,6,11,11,11,11,11,11,11,2,2,14,14,14,14,34,34,34,34,1,1,1,1,17,17,18,3,3,3,2,1,1,0,3,3}
weat_desert = {1,1,1,1,1,19,1,1,61,61,58,28,28,28,18,11,11,11,11,11,11,11,2,2,14,14,14,14,34,34,34,34,1,1,1,1,17,17,18,18,2,2,2,1,1,0,3,19}
weat_lv = {12,12,15,15,66,66,12,12,61,58,28,28,28,28,18,11,11,11,11,11,11,11,2,2,14,14,14,14,34,34,34,34,1,1,1,1,17,17,18,3,3,3,2,1,1,0,3,3}

weat_zone = {
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,1,2,1,1,1,1,1,1,1,1,1,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,1,2,2,2,2,2,2,2,1,1,1,4,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,1,1,1,4,4,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,4,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,4,4,4,4,4,4,8,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,4,4,4,8,8,8,8,8,8,8,8,8,8,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,2,2,1,1,2,2,2,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1},
{1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1}
}

function wheaterStep(imm)
if (getElementInterior(getLocalPlayer()) == 0 ) then
	local hour,mins = getTime()
	hour = hour * 2
	if (mins>=30) then
		hour = hour + 1
	end
	local x,y,z = getElementPosition(getLocalPlayer())
	local px = math.floor((x+4000)/200)
	local py = math.floor((y+4000)/200)
	if (px<1) then
		px = 1
	elseif (px>40) then
		px = 40
		end
	if (py<1) then
		py = 1
	elseif (py>40) then
		py = 40
		end
	py = 41 - py
	local zone = weat_zone[py][px]
	if (zone == 2) then
		weat = 9
	elseif (zone == 4) then
		weat = 12
	elseif (zone == 8) then
		weat = 8
	else
		weat = 12
	end
	local cyc_power = 0
	for i, cyc in pairs(cyclones) do
	if (cyc[3]>0) then
		local dist = getDistanceBetweenPoints2D (x, y, cyc[1], cyc[2])
		if (cyc[3]>600) then
			if (dist<cyc[3]/4) then
				cyc_power = math.max(cyc_power,3)
			elseif (dist<cyc[3]*1/2) then
				cyc_power = math.max(cyc_power,2) 
			elseif (dist<cyc[3]) then
				cyc_power = math.max(cyc_power,1) 
			end
		else
			if (dist<cyc[3]/2) then
				cyc_power = math.max(cyc_power,2)
			elseif (dist<cyc[3]) then
				cyc_power = math.max(cyc_power,1)
			end
		end
	end
	end
	if (cyc_power==3) then
		if (zone==4) then
			weat = 12
		else
			weat = 8
		end
	elseif (cyc_power==2) then
		if ((hour>2)and(hour<38)) then
			weat = 8
		else
			weat = 9
		end		
	elseif (cyc_power==1) then
		weat = 7
	end
	if (imm==0) then 
		setWeather(12)
	else
		setWeather(8)
	end
end
end

function onPlayerSpawn()
	if (source==getLocalPlayer()) then
		wheaterStep(1)
	end
end
addEventHandler("onClientPlayerSpawn",getLocalPlayer(),onPlayerSpawn)
setTimer(wheaterStep,10000,0,0)

function weatherConfig ()
	setTrafficLightsLocked(false)
	setMinuteDuration(45000)
	setTrafficLightState(9)
end
addEventHandler("onClientResourceStart",getRootElement(),weatherConfig)